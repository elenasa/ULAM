## -*- mode:ulam -*-
#=t41318_test_compiler_elementandquark_multibasesisasbase_virtualfuncswsharedancestoranddatamembercopies
##
## gen output:
## Int Arg: 410 (+ 5 asserts)
## Int Arg: 410 (+ 5 asserts)
##
#!
Exit status: -11
Ue_Foo +System { +<> Int(32) m_c4(0);  Int(32) m_a4(0);  Int(32) test() {  typedef QBase2 QB2;  typedef QBase1 QB1;  Atom(96) a = E4.instanceof cast;  { a QBase2 as cond { QBase2& a;  m_a4 a ( )vfunca . = ( m_a4 )print ( m_a4 410 cast == )assert ( a m_b1 . )assert } if } E4& e4ref = a cast;  ( e4ref m_b4 . )assert ( e4ref QB2 . m_b1 . )assert ( e4ref QBaseLast . m_b1 . )assert Atom(96) b = E4.instanceof cast;  QBase2& qb2ref = b cast;  m_c4 qb2ref ( )vfunca . = ( m_c4 )print ( m_c4 410 cast == )assert E4& e4bref = b cast;  ( e4bref m_b1 . ! )assert ( e4bref m_b4 . )assert ( e4bref QB2 . m_b1 . )assert ( e4bref QBaseLast . m_b1 . )assert 0 cast return } }
Uq_System { <NOMAIN> }
Ue_E4 : QBase3 +QBase2 +QBaseLast { :< :< Bool(1) m_b1(false); > Bool(1) m_b3(false); > +< +< Bool(1) m_b1(false); > Bool(1) m_b2(false);  Bits(1) m_bit(0); > +< :< Bool(1) m_b1(false); > Bool(7) m_blast(false); > Bool(1) m_b4(false);  typedef QBase2 QB2;  <NOMAIN> }
Uq_QBase3 : QBase1 { :< Bool(1) m_b1(false); > Bool(1) m_b3(false);  <NOMAIN> }
Uq_QBase2 +QBase1 { +< Bool(1) m_b1(false); > Bool(1) m_b2(false);  Bits(1) m_bit(0);  <NOMAIN> }
Uq_QBaseLast : QBase1 { :< Bool(1) m_b1(false); > Bool(7) m_blast(false);  <NOMAIN> }
Uq_QBase1 { Bool(1) m_b1(false);  <NOMAIN> }
##
##       informed by t41317 and t41315: e4 data member not accessible within as-block, but
##       successfully modified by the e4 override func call.
##
#>Foo.ulam
  ulam 4;
element Foo +System {
  Int m_c4;
  Int m_a4;

  Int test()
  {
    typedef E4.QB2 QB2;
    typedef QBase3.Super QB1;

    Atom a = E4.instanceof;

    if(a as QBase2)
    {
      m_a4 = a.vfunca(); //410
      print(m_a4);
      assert(m_a4==410);

      //multiple copies of QBase1:
      assert(a.m_b1);
    }

    E4& e4ref = (E4&) a;
    assert(e4ref.m_b4); //m_b4 not defined within as-block
    assert(e4ref.QB2.m_b1); //equivalent dm, in order FAILS.
    assert(e4ref.QBaseLast.m_b1); //explicitly changed


    //COMPARE GEN CODE: as- with ref-
    Atom b = E4.instanceof;
    QBase2& qb2ref = (QBase2&) b;

    m_c4 = qb2ref.vfunca(); //410
    print(m_c4);
    assert(m_c4==410);

    //multiple copies of QBase1:
    E4& e4bref = (E4&) b;
    assert(!e4bref.m_b1); //QB3's untouched

    assert(e4bref.m_b4);
    assert(e4bref.QB2.m_b1); //equivalent dm, orderwise FAILS.
    assert(e4bref.QBaseLast.m_b1); //explicitly changed
    return 0;
  }
}


#:E4.ulam
  ulam 4;
element E4 : QBase3 +QBase2 +QBaseLast {
  Bool m_b4;
  virtual Int vfuncc() { return 412; }
  virtual Int vfunca() { m_b1 = true; m_b4 = true; self.QBaseLast.m_b1 = true; return 410; }
  virtual Void behave() { }
  typedef QBase2 QB2;
}

#:QBase1.ulam
    ulam 4;
quark QBase1 {
  Bool m_b1;
  Void funcNotVirtualSoIrrelevantHere() { }
  virtual Int vfunca() { m_b1 = true; return 110; }
}

#:QBase2.ulam
  ulam 4;
quark QBase2 +QBase1 {
  Bool m_b2;
  Bits(1) m_bit; //so that len of QBase2 is different than its pos in E4.
  virtual ARGB getColor(Unsigned s) { return super.getColor(s); }
  virtual Int vfuncc() { m_b2 = true; return 212; }
}

#:QBase3.ulam
  ulam 4;
quark QBase3 : QBase1 {
  Bool m_b3;
  virtual Int vfuncb() { return 311; }
}

#:QBaseLast.ulam
  ulam 4;
quark QBaseLast : QBase1 {
  Bool(7) m_blast;
}


#:System.ulam
ulam 1;
quark System {
Void print(Unsigned arg) native;
Void print(Int arg) native;
Void print(Int(4) arg) native;
Void print(Int(3) arg) native;
Void print(Unary(3) arg) native;
Void print(Bool(3) arg) native;
Void assert(Bool b) native;
}

#.
